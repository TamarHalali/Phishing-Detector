name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: phishing_db
          MYSQL_USER: phishing_user
          MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping -h localhost" --health-interval=10s --health-timeout=5s --health-retries=10 --health-start-period=30s

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Wait for MySQL
      run: |
        while ! mysqladmin ping -h"127.0.0.1" --silent; do
          sleep 1
        done
    
    - name: Run tests
      env:
        DATABASE_URL: mysql+pymysql://phishing_user:${{ secrets.MYSQL_PASSWORD }}@127.0.0.1:3306/phishing_db
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
      run: |
        cd backend
        python -m pytest tests/ -v

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: needs.test.result == 'success'
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Login to Docker Hub
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    
    - name: Get next version
      id: version
      run: |
        LATEST_TAG=$(git tag -l "v*" --sort=-version:refname | head -n1)
        if [ -z "$LATEST_TAG" ]; then
          VERSION="1.0.0"
        else
          CURRENT_VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          PATCH=$((PATCH + 1))
          VERSION="$MAJOR.$MINOR.$PATCH"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git tag "v$VERSION"
        git push origin "v$VERSION"
    
    - name: Build and Push Images
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      run: |
        # Backend
        cd backend
        docker build -t $DOCKERHUB_USERNAME/phishing-detector-backend:${{ steps.version.outputs.VERSION }} .
        docker build -t $DOCKERHUB_USERNAME/phishing-detector-backend:latest .
        docker push $DOCKERHUB_USERNAME/phishing-detector-backend:${{ steps.version.outputs.VERSION }}
        docker push $DOCKERHUB_USERNAME/phishing-detector-backend:latest
        
        # Frontend
        cd ../frontend
        docker build -t $DOCKERHUB_USERNAME/phishing-detector-frontend:${{ steps.version.outputs.VERSION }} .
        docker build -t $DOCKERHUB_USERNAME/phishing-detector-frontend:latest .
        docker push $DOCKERHUB_USERNAME/phishing-detector-frontend:${{ steps.version.outputs.VERSION }}
        docker push $DOCKERHUB_USERNAME/phishing-detector-frontend:latest
